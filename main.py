import r2pipe
import os
import re
import json
import networkx as nx
import numpy as np
import sys
import matplotlib.pyplot as plt
import argparse

np.set_printoptions(threshold=np.inf)

parser = argparse.ArgumentParser(description='Extract Adjacency matrix / graph from PE')
parser.add_argument('file', nargs='*',  help="The file to analyze")

args = parser.parse_args()



def allFunction(f):
    """ Print all function from PE """
    result = []
    x = f.cmdj("aflj")

    for i in range(0, int(f.cmd("aflc"))):
        data = json.dumps(x[i]['name'])
        if ("fcn." in data) or ("entry0" in data) :
            result.append(data.replace('"',''))
    return result


def ActionBasicBloc(nameFunction, *args):
    """  
        Print adjacency_matrix of Graph
        if args = save, save the graph to png
    """
    G = initGraph()
    cpt = 0
    bb = f.cmd("afb " + nameFunction)

    for i in bb.splitlines():
        index = i.split(' ')
        if cpt == 0:
            G.add_node(index[0], color='green', style='filled')
        elif cpt == G.number_of_nodes() -1 :
            G.add_node(index[0], color='red', style='filled')
        else:
            G.add_node(index[0])
        cpt = cpt + 1
        if "f" in index :
            G.add_edges_from([(index[0], index[5]),(index[0],index[7])], weight=1)
        elif "j" in index :
            G.add_edge(index[0], index[5], weight=1)
        else :
            pass

    color_d = nx.get_node_attributes(G, 'color')
    default_color = 'blue'
    color_l = [color_d.get(node, default_color) for node in G.nodes()]
    if 'save' in args :
        print(nx.to_numpy_matrix(G))
        nx.draw(G, node_color=color_l)
        plt.savefig("graph_" + str(nameFunction) + ".png")
    elif 'print' in args :
        print("\nMethode " + str(nameFunction) + " Nombre de noeud " + str(G.number_of_nodes()))
        [print(nameFunction, n, nbrdict) for n, nbrdict in G.adjacency()]
        print(nx.to_numpy_matrix(G))
    else:
        print(nx.to_numpy_matrix(G))

    
def initGraph():
    return nx.MultiDiGraph()


if __name__=="__main__":
    print(args.file)

    if args.file  :
        if os.path.isfile(args.file[0]):
            try :
                f = r2pipe.open(args.file[0])
                f.cmd("e asm.bytes = 0")
                f.cmd("e scr.utf8 = true")
                f.cmd("aaa")
                listeDesFonctions = allFunction(f)
                print("Nombre de m√©thodes : " + str(len(listeDesFonctions)))
                [ActionBasicBloc(fc, "print") for fc in listeDesFonctions]
            except FileNotFoundError:
                print("error opening file")
        else :
            print("file doesn't exist")
    else:
        parser.print_help()
    
	
    
